<script>
  const msalConfig = {
    auth: {
      clientId: "ccefd627-1db6-4e1e-b346-3854e82ea9e5",
      authority: "https://login.microsoftonline.com/457051ff-d001-4f04-9afa-892af205a547",
      redirectUri: "https://mygmmco.gmmco.in/ci-dashboard/login.html" // login.html registered in Azure
    }
  };
  const msalInstance = new msal.PublicClientApplication(msalConfig);

  const allowedEmails = [
    "arunprasad.r@gmmcoindia.com","meenakshi.v@gmmcoindia.com","priyadharshini.m@gmmcoindia.com",
    "hpramod@gmmcoindia.com","rahul.s@gmmcoindia.com","chandrashekar.v@gmmcoindia.com",
    "shahid@gmmcoindia.com","manikandan.g@gmmcoindia.com","jrajkumar@gmmcoindia.com",
    "karansingh.r@gmmcoindia.com","josephmartin@gmmcoindia.com","sameer.w@gmmcoindia.com",
    "anshajsingh.a@gmmcoindia.com","kumaresan.p@gmmcoindia.com","presely.a@gmmcoindia.com",
    "user18@gmmco.in","user19@gmmco.in","user20@gmmco.in"
  ];

  // üîπ Handle login result (popup or redirect)
  function handleLoginResponse(response) {
    const account = response?.account || msalInstance.getAllAccounts()[0];
    if (!account) return;

    const userEmail = account.username.toLowerCase();
    if (allowedEmails.includes(userEmail)) {
      localStorage.setItem("gmmcoLoggedIn", "true");
      localStorage.setItem("gmmcoEmail", userEmail);
      window.location.href = "/ci-dashboard/index.html";
    } else {
      alert("Access denied: Your account is not authorized.");
      localStorage.clear();
    }
  }

  // üîπ Restore session if already logged in
  const accounts = msalInstance.getAllAccounts();
  if (accounts.length > 0) {
    handleLoginResponse({ account: accounts[0] });
  }

  // üîπ Handle redirect login result (for mobile)
  msalInstance.handleRedirectPromise().then((response) => {
    if (response) {
      handleLoginResponse(response);
    }
  }).catch((error) => {
    console.error("Redirect error:", error);
  });

  // üîπ Login function (popup for desktop, redirect for mobile)
  async function loginWithAzure() {
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);

    try {
      if (isMobile) {
        await msalInstance.loginRedirect({ scopes: ["User.Read"] });
      } else {
        const response = await msalInstance.loginPopup({ scopes: ["User.Read"] });
        handleLoginResponse(response);
      }
    } catch (error) {
      console.error(error);
      alert("‚ö†Ô∏è Login failed. Please allow popups/redirects in your browser and try again.");
    }
  }
</script>
